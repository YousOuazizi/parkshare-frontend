import{a as n}from"./chunk-ENVM6CV3.js";import{a as S,b as E}from"./chunk-BJ67WPCT.js";import{c as v}from"./chunk-GET3MYAY.js";import{C as l,Ta as p,W as c,Z as u,da as g,l as d,nc as o,y as m}from"./chunk-JQWXTQXA.js";var f=class s{setItem(e,t){try{let r=JSON.stringify(t);localStorage.setItem(e,r)}catch(r){console.error("Error saving to localStorage",r)}}getItem(e){try{let t=localStorage.getItem(e);return t?JSON.parse(t):null}catch(t){return console.error("Error reading from localStorage",t),null}}removeItem(e){localStorage.removeItem(e)}clear(){localStorage.clear()}hasItem(e){return localStorage.getItem(e)!==null}setSessionItem(e,t){try{let r=JSON.stringify(t);sessionStorage.setItem(e,r)}catch(r){console.error("Error saving to sessionStorage",r)}}getSessionItem(e){try{let t=sessionStorage.getItem(e);return t?JSON.parse(t):null}catch(t){return console.error("Error reading from sessionStorage",t),null}}removeSessionItem(e){sessionStorage.removeItem(e)}static \u0275fac=function(t){return new(t||s)};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})};var i=class extends Error{};i.prototype.name="InvalidTokenError";function L(s){return decodeURIComponent(atob(s).replace(/(.)/g,(e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function A(s){let e=s.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return L(e)}catch{return atob(e)}}function R(s,e){if(typeof s!="string")throw new i("Invalid token specified: must be a string");e||(e={});let t=e.header===!0?0:1,r=s.split(".")[t];if(typeof r!="string")throw new i(`Invalid token specified: missing part #${t+1}`);let h;try{h=A(r)}catch(a){throw new i(`Invalid token specified: invalid base64 for part #${t+1} (${a.message})`)}try{return JSON.parse(h)}catch(a){throw new i(`Invalid token specified: invalid json for part #${t+1} (${a.message})`)}}var T=class s{api=g(E);storage=g(f);router=g(v);currentUserSignal=p(null);isAuthenticatedSignal=p(!1);isLoadingSignal=p(!1);currentUser=this.currentUserSignal.asReadonly();isAuthenticated=this.isAuthenticatedSignal.asReadonly();isLoading=this.isLoadingSignal.asReadonly();isAdmin=o(()=>this.currentUserSignal()?.role==="ADMIN");isOwner=o(()=>this.currentUserSignal()?.role==="OWNER"||this.currentUserSignal()?.role==="ADMIN");verificationLevel=o(()=>this.currentUserSignal()?.verificationLevel||"LEVEL_0");canBook=o(()=>{let e=this.verificationLevel();return e==="LEVEL_2"||e==="LEVEL_3"||e==="LEVEL_4"});canPublishParking=o(()=>{let e=this.verificationLevel();return e==="LEVEL_3"||e==="LEVEL_4"});ACCESS_TOKEN_KEY="access_token";REFRESH_TOKEN_KEY="refresh_token";tokenRefreshSubscription;constructor(){this.initializeAuth()}initializeAuth(){let e=this.getAccessToken();e&&!this.isTokenExpired(e)?(this.loadUserProfile(),this.startTokenRefreshTimer()):this.clearAuth()}register(e){return this.isLoadingSignal.set(!0),this.api.post(n.AUTH.REGISTER,e).pipe(c(t=>this.handleAuthSuccess(t)),l(t=>{throw this.isLoadingSignal.set(!1),t}))}login(e){return this.isLoadingSignal.set(!0),this.api.post(n.AUTH.LOGIN,e).pipe(c(t=>this.handleAuthSuccess(t)),l(t=>{throw this.isLoadingSignal.set(!1),t}))}logout(){return this.api.post(n.AUTH.LOGOUT,{}).pipe(c(()=>{this.clearAuth(),this.router.navigate(["/auth/login"])}),l(()=>(this.clearAuth(),this.router.navigate(["/auth/login"]),d(null))))}refreshToken(){let e=this.getRefreshToken();return e?this.api.post(n.AUTH.REFRESH,{refreshToken:e}).pipe(c(t=>{this.storage.setItem(this.ACCESS_TOKEN_KEY,t.accessToken),t.refreshToken&&this.storage.setItem(this.REFRESH_TOKEN_KEY,t.refreshToken)}),l(t=>{throw this.clearAuth(),t})):(this.clearAuth(),d({}))}loadUserProfile(){this.api.get(n.AUTH.PROFILE).subscribe({next:e=>{this.currentUserSignal.set(e),this.isAuthenticatedSignal.set(!0),this.isLoadingSignal.set(!1)},error:()=>{this.clearAuth()}})}getAccessToken(){return this.storage.getItem(this.ACCESS_TOKEN_KEY)}getRefreshToken(){return this.storage.getItem(this.REFRESH_TOKEN_KEY)}isTokenExpired(e){try{let t=R(e);return new Date(t.exp*1e3)<new Date}catch{return!0}}handleAuthSuccess(e){this.storage.setItem(this.ACCESS_TOKEN_KEY,e.accessToken),this.storage.setItem(this.REFRESH_TOKEN_KEY,e.refreshToken),this.currentUserSignal.set(e.user),this.isAuthenticatedSignal.set(!0),this.isLoadingSignal.set(!1),this.startTokenRefreshTimer()}clearAuth(){this.storage.removeItem(this.ACCESS_TOKEN_KEY),this.storage.removeItem(this.REFRESH_TOKEN_KEY),this.currentUserSignal.set(null),this.isAuthenticatedSignal.set(!1),this.isLoadingSignal.set(!1),this.stopTokenRefreshTimer()}startTokenRefreshTimer(){this.stopTokenRefreshTimer(),this.tokenRefreshSubscription=m(S.tokenRefreshInterval).subscribe(()=>{this.refreshToken().subscribe()})}stopTokenRefreshTimer(){this.tokenRefreshSubscription&&this.tokenRefreshSubscription.unsubscribe()}hasRole(e){return this.currentUserSignal()?.role===e}hasAnyRole(e){let t=this.currentUserSignal()?.role;return t?e.includes(t):!1}hasMinimumVerificationLevel(e){let t=this.verificationLevel(),r=["LEVEL_0","LEVEL_1","LEVEL_2","LEVEL_3","LEVEL_4"],h=r.indexOf(t),a=r.indexOf(e);return h>=a}updateCurrentUser(e){this.currentUserSignal.set(e)}static \u0275fac=function(t){return new(t||s)};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})};export{T as a};
