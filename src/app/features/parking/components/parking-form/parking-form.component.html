<div class="parking-form-container">
  <div class="form-header">
    <h1>{{ isEditMode() ? 'Edit' : 'Add New' }} Parking Space</h1>
    <p class="subtitle">
      {{ isEditMode() ? 'Update your parking space details' : 'List your parking space and start earning' }}
    </p>
  </div>

  @if (isLoading()) {
    <div class="loading-spinner">
      <mat-spinner></mat-spinner>
      <p>Loading parking data...</p>
    </div>
  } @else {
    <mat-stepper #stepper linear class="parking-stepper">
      <!-- Step 1: Basic Information -->
      <mat-step [stepControl]="basicInfoForm" label="Basic Info">
        <form [formGroup]="basicInfoForm" class="step-form">
          <h2>Basic Information</h2>
          <p class="step-description">Provide essential details about your parking space</p>

          <mat-form-field appearance="outline">
            <mat-label>Title</mat-label>
            <input
              matInput
              formControlName="title"
              placeholder="e.g., Secure Covered Parking Downtown"
              maxlength="100"
            />
            <mat-hint align="end">{{ basicInfoForm.get('title')?.value?.length || 0 }}/100</mat-hint>
            @if (basicInfoForm.get('title')?.hasError('required') && basicInfoForm.get('title')?.touched) {
              <mat-error>Title is required</mat-error>
            }
            @if (basicInfoForm.get('title')?.hasError('minlength')) {
              <mat-error>Title must be at least 5 characters</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Description</mat-label>
            <textarea
              matInput
              formControlName="description"
              placeholder="Describe your parking space, nearby landmarks, and any special features..."
              rows="5"
              maxlength="1000"
            ></textarea>
            <mat-hint align="end">{{ basicInfoForm.get('description')?.value?.length || 0 }}/1000</mat-hint>
            @if (basicInfoForm.get('description')?.hasError('required') && basicInfoForm.get('description')?.touched) {
              <mat-error>Description is required</mat-error>
            }
            @if (basicInfoForm.get('description')?.hasError('minlength')) {
              <mat-error>Description must be at least 20 characters</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Access Method</mat-label>
            <mat-select formControlName="accessMethod">
              @for (method of accessMethods; track method) {
                <mat-option [value]="method">
                  {{ method }}
                </mat-option>
              }
            </mat-select>
            <mat-hint>How will renters access the parking space?</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Access Instructions (Optional)</mat-label>
            <textarea
              matInput
              formControlName="accessInstructions"
              placeholder="Provide detailed instructions on how to access the parking space..."
              rows="3"
              maxlength="500"
            ></textarea>
            <mat-hint align="end">{{ basicInfoForm.get('accessInstructions')?.value?.length || 0 }}/500</mat-hint>
          </mat-form-field>

          <div class="step-actions">
            <button mat-button (click)="onCancel()" type="button">Cancel</button>
            <button mat-raised-button color="primary" matStepperNext type="button">Next</button>
          </div>
        </form>
      </mat-step>

      <!-- Step 2: Location -->
      <mat-step [stepControl]="locationForm" label="Location">
        <form [formGroup]="locationForm" class="step-form">
          <h2>Location</h2>
          <p class="step-description">Where is your parking space located?</p>

          <mat-form-field appearance="outline">
            <mat-label>Street Address</mat-label>
            <input
              matInput
              formControlName="address"
              placeholder="123 Main Street"
              (input)="searchAddress($any($event.target).value)"
            />
            <mat-icon matSuffix>location_on</mat-icon>
            <mat-hint>Start typing to search for your address</mat-hint>
            @if (locationForm.get('address')?.hasError('required') && locationForm.get('address')?.touched) {
              <mat-error>Address is required</mat-error>
            }
          </mat-form-field>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>City</mat-label>
              <input
                matInput
                formControlName="city"
                placeholder="San Francisco"
              />
              @if (locationForm.get('city')?.hasError('required') && locationForm.get('city')?.touched) {
                <mat-error>City is required</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Country</mat-label>
              <input
                matInput
                formControlName="country"
                placeholder="United States"
              />
              @if (locationForm.get('country')?.hasError('required') && locationForm.get('country')?.touched) {
                <mat-error>Country is required</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="coordinates-section">
            <h3>GPS Coordinates</h3>
            <button
              mat-stroked-button
              color="primary"
              type="button"
              (click)="useCurrentLocation()"
              class="location-button"
            >
              <mat-icon>my_location</mat-icon>
              Use Current Location
            </button>

            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Latitude</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="latitude"
                  placeholder="37.7749"
                  step="0.000001"
                />
                @if (locationForm.get('latitude')?.hasError('required') && locationForm.get('latitude')?.touched) {
                  <mat-error>Latitude is required</mat-error>
                }
                @if (locationForm.get('latitude')?.hasError('min') || locationForm.get('latitude')?.hasError('max')) {
                  <mat-error>Invalid latitude (-90 to 90)</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Longitude</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="longitude"
                  placeholder="-122.4194"
                  step="0.000001"
                />
                @if (locationForm.get('longitude')?.hasError('required') && locationForm.get('longitude')?.touched) {
                  <mat-error>Longitude is required</mat-error>
                }
                @if (locationForm.get('longitude')?.hasError('min') || locationForm.get('longitude')?.hasError('max')) {
                  <mat-error>Invalid longitude (-180 to 180)</mat-error>
                }
              </mat-form-field>
            </div>
          </div>

          <div class="step-actions">
            <button mat-button matStepperPrevious type="button">Back</button>
            <button mat-raised-button color="primary" matStepperNext type="button">Next</button>
          </div>
        </form>
      </mat-step>

      <!-- Step 3: Pricing & Size -->
      <mat-step [stepControl]="pricingForm" label="Pricing & Size">
        <form [formGroup]="pricingForm" class="step-form">
          <h2>Pricing & Size</h2>
          <p class="step-description">Set your pricing and specify parking space dimensions</p>

          <div class="pricing-section">
            <h3>Pricing</h3>
            <div class="form-row">
              <mat-form-field appearance="outline" class="price-field">
                <mat-label>Base Price per Hour</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="basePrice"
                  placeholder="5.00"
                  step="0.50"
                  min="0.01"
                />
                <span matTextPrefix>$&nbsp;</span>
                <mat-hint>Your hourly rate</mat-hint>
                @if (pricingForm.get('basePrice')?.hasError('required') && pricingForm.get('basePrice')?.touched) {
                  <mat-error>Price is required</mat-error>
                }
                @if (pricingForm.get('basePrice')?.hasError('min')) {
                  <mat-error>Price must be greater than 0</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Currency</mat-label>
                <mat-select formControlName="currency">
                  @for (curr of currencies; track curr) {
                    <mat-option [value]="curr">{{ curr }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>

            <div class="ev-charging">
              <mat-slide-toggle formControlName="hasEVCharging" color="primary">
                <div class="toggle-content">
                  <mat-icon>ev_station</mat-icon>
                  <span>EV Charging Available</span>
                </div>
              </mat-slide-toggle>
            </div>
          </div>

          <div class="size-section" formGroupName="size">
            <h3>Parking Space Dimensions</h3>
            <p class="info-text">Provide dimensions in feet</p>

            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Length (ft)</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="length"
                  placeholder="18"
                  min="1"
                />
                <mat-icon matSuffix>straighten</mat-icon>
                @if (pricingForm.get('size.length')?.hasError('required') && pricingForm.get('size.length')?.touched) {
                  <mat-error>Length is required</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Width (ft)</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="width"
                  placeholder="9"
                  min="1"
                />
                <mat-icon matSuffix>straighten</mat-icon>
                @if (pricingForm.get('size.width')?.hasError('required') && pricingForm.get('size.width')?.touched) {
                  <mat-error>Width is required</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Height (ft)</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="height"
                  placeholder="7"
                  min="1"
                />
                <mat-icon matSuffix>height</mat-icon>
                <mat-hint>Clearance height</mat-hint>
                @if (pricingForm.get('size.height')?.hasError('required') && pricingForm.get('size.height')?.touched) {
                  <mat-error>Height is required</mat-error>
                }
              </mat-form-field>
            </div>
          </div>

          <div class="features-section">
            <h3>Features & Amenities</h3>
            <p class="info-text">Select all that apply</p>
            <div class="features-grid">
              @for (feature of availableFeatures; track feature) {
                <mat-chip
                  [class.selected]="isFeatureSelected(feature)"
                  (click)="toggleFeature(feature)"
                >
                  {{ feature }}
                </mat-chip>
              }
            </div>
          </div>

          <div class="step-actions">
            <button mat-button matStepperPrevious type="button">Back</button>
            <button mat-raised-button color="primary" matStepperNext type="button">Next</button>
          </div>
        </form>
      </mat-step>

      <!-- Step 4: Photos -->
      <mat-step label="Photos">
        <div class="step-form">
          <h2>Photos</h2>
          <p class="step-description">Add photos to showcase your parking space</p>

          <div class="photos-upload-section">
            <div class="upload-area">
              <input
                type="file"
                #fileInput
                (change)="onPhotoSelected($event)"
                accept="image/*"
                multiple
                hidden
              />
              <button
                mat-raised-button
                color="primary"
                type="button"
                (click)="fileInput.click()"
              >
                <mat-icon>add_photo_alternate</mat-icon>
                Upload Photos
              </button>
              <p class="upload-hint">
                Maximum 5MB per image. Accepted formats: JPG, PNG, WebP
              </p>
            </div>

            @if (photosPreviews().length > 0) {
              <div class="photos-preview-grid">
                @for (photo of photosPreviews(); track $index) {
                  <div class="photo-preview-card">
                    <img [src]="photo.url" [alt]="'Photo ' + ($index + 1)" />
                    <div class="photo-actions">
                      <button
                        mat-icon-button
                        (click)="movePhotoUp($index)"
                        [disabled]="$index === 0"
                        type="button"
                        matTooltip="Move up"
                      >
                        <mat-icon>arrow_upward</mat-icon>
                      </button>
                      <button
                        mat-icon-button
                        (click)="movePhotoDown($index)"
                        [disabled]="$index === photosPreviews().length - 1"
                        type="button"
                        matTooltip="Move down"
                      >
                        <mat-icon>arrow_downward</mat-icon>
                      </button>
                      <button
                        mat-icon-button
                        color="warn"
                        (click)="removePhoto($index)"
                        type="button"
                        matTooltip="Remove"
                      >
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                    <div class="photo-order">{{ $index + 1 }}</div>
                  </div>
                }
              </div>
            } @else {
              <div class="no-photos">
                <mat-icon>photo_library</mat-icon>
                <p>No photos uploaded yet</p>
                <p class="hint">Add photos to make your listing more attractive</p>
              </div>
            }
          </div>

          <div class="step-actions">
            <button mat-button matStepperPrevious type="button">Back</button>
            <button mat-raised-button color="primary" matStepperNext type="button">Next</button>
          </div>
        </div>
      </mat-step>

      <!-- Step 5: Availability -->
      <mat-step label="Availability">
        <div class="step-form">
          <h2>Availability Schedule</h2>
          <p class="step-description">Set when your parking space is available for booking</p>

          <div class="availability-section">
            @for (day of weekDays; track day.dayOfWeek) {
              <div class="day-schedule-card">
                <div class="day-header">
                  <mat-slide-toggle
                    [(ngModel)]="day.enabled"
                    [ngModelOptions]="{standalone: true}"
                    color="primary"
                  >
                    <strong>{{ day.day }}</strong>
                  </mat-slide-toggle>
                </div>

                @if (day.enabled) {
                  <div class="time-inputs">
                    <mat-form-field appearance="outline">
                      <mat-label>Start Time</mat-label>
                      <input
                        matInput
                        type="time"
                        [(ngModel)]="day.startTime"
                        [ngModelOptions]="{standalone: true}"
                      />
                      <mat-icon matSuffix>schedule</mat-icon>
                    </mat-form-field>

                    <span class="time-separator">to</span>

                    <mat-form-field appearance="outline">
                      <mat-label>End Time</mat-label>
                      <input
                        matInput
                        type="time"
                        [(ngModel)]="day.endTime"
                        [ngModelOptions]="{standalone: true}"
                      />
                      <mat-icon matSuffix>schedule</mat-icon>
                    </mat-form-field>
                  </div>
                }
              </div>
            }
          </div>

          <div class="step-actions">
            <button mat-button matStepperPrevious type="button">Back</button>
            <button
              mat-raised-button
              color="accent"
              type="button"
              (click)="onSubmit()"
              [disabled]="isSaving()"
            >
              @if (isSaving()) {
                <mat-spinner diameter="20"></mat-spinner>
                <span>Saving...</span>
              } @else {
                <mat-icon>save</mat-icon>
                <span>{{ isEditMode() ? 'Update' : 'Create' }} Parking</span>
              }
            </button>
          </div>
        </div>
      </mat-step>
    </mat-stepper>
  }
</div>
