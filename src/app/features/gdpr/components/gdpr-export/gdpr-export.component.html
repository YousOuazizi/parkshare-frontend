<div class="gdpr-export-container">
  <!-- Header -->
  <div class="export-header">
    <div class="header-content">
      <div class="title-section">
        <mat-icon class="header-icon">cloud_download</mat-icon>
        <div>
          <h1>Data Export</h1>
          <p class="subtitle">Request and download your personal data</p>
        </div>
      </div>
      <div class="header-actions">
        <button
          mat-raised-button
          color="primary"
          (click)="loadExportRequests()"
          [disabled]="loading()"
        >
          @if (loading()) {
            <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
          } @else {
            <mat-icon>refresh</mat-icon>
          }
          Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Error State -->
  @if (error()) {
    <mat-card class="error-card">
      <mat-card-content>
        <div class="error-content">
          <mat-icon class="error-icon">error</mat-icon>
          <div>
            <h3>Error Loading Export Requests</h3>
            <p>{{ error() }}</p>
            <button mat-raised-button color="primary" (click)="loadExportRequests()">
              <mat-icon>refresh</mat-icon>
              Try Again
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  }

  <div class="export-content">
    <!-- Request New Export -->
    <mat-card class="request-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>add_circle</mat-icon>
          Request Data Export
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <!-- Data Categories -->
        <div class="section">
          <div class="section-header">
            <h3>
              <mat-icon>folder</mat-icon>
              Select Data Categories
            </h3>
            <mat-checkbox
              [checked]="areAllCategoriesSelected()"
              [indeterminate]="areSomeCategoriesSelected()"
              (change)="toggleAllCategories($event.checked)"
              color="primary"
            >
              Select All
            </mat-checkbox>
          </div>
          <div class="categories-grid">
            @for (category of dataCategories(); track category.id) {
              <div class="category-card" [class.selected]="category.selected">
                <mat-checkbox
                  [checked]="category.selected"
                  (change)="toggleCategory(category)"
                  color="primary"
                  class="category-checkbox"
                >
                  <div class="category-content">
                    <mat-icon class="category-icon">{{ category.icon }}</mat-icon>
                    <div class="category-details">
                      <h4>{{ category.label }}</h4>
                      <p>{{ category.description }}</p>
                    </div>
                  </div>
                </mat-checkbox>
              </div>
            }
          </div>
          <div class="selection-summary">
            <mat-icon>info</mat-icon>
            <span>{{ getSelectedCategoriesCount() }} of {{ dataCategories().length }} categories selected</span>
          </div>
        </div>

        <!-- Export Format -->
        <div class="section">
          <div class="section-header">
            <h3>
              <mat-icon>settings</mat-icon>
              Export Format
            </h3>
          </div>
          <mat-radio-group [(ngModel)]="selectedFormat" class="format-group">
            @for (format of exportFormats; track format.id) {
              <mat-radio-button [value]="format.id" color="primary" class="format-option">
                <div class="format-content">
                  <mat-icon>{{ format.icon }}</mat-icon>
                  <div>
                    <div class="format-label">{{ format.label }}</div>
                    <div class="format-description">{{ format.description }}</div>
                  </div>
                </div>
              </mat-radio-button>
            }
          </mat-radio-group>
        </div>

        <!-- Request Button -->
        <div class="request-actions">
          <button
            mat-raised-button
            color="primary"
            (click)="requestExport()"
            [disabled]="requesting() || getSelectedCategoriesCount() === 0"
            class="request-button"
          >
            @if (requesting()) {
              <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
              Processing...
            } @else {
              <mat-icon>cloud_download</mat-icon>
              Request Export
            }
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Export History -->
    <mat-card class="history-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>history</mat-icon>
          Export History
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        @if (loading() && exportRequests().length === 0) {
          <div class="loading-container">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Loading export history...</p>
          </div>
        } @else if (exportRequests().length === 0) {
          <div class="empty-state">
            <mat-icon>folder_open</mat-icon>
            <h3>No Export Requests</h3>
            <p>You haven't requested any data exports yet</p>
          </div>
        } @else {
          <div class="table-container">
            <table mat-table [dataSource]="exportRequests()" class="export-table">
              <!-- Status Column -->
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>Status</th>
                <td mat-cell *matCellDef="let request">
                  <mat-chip [class]="'status-chip ' + getStatusColor(request.status)">
                    <mat-icon>{{ getStatusIcon(request.status) }}</mat-icon>
                    {{ getStatusLabel(request.status) }}
                  </mat-chip>
                </td>
              </ng-container>

              <!-- Request Date Column -->
              <ng-container matColumnDef="requestDate">
                <th mat-header-cell *matHeaderCellDef>Requested</th>
                <td mat-cell *matCellDef="let request">
                  {{ formatDate(request.createdAt) }}
                </td>
              </ng-container>

              <!-- Download URL Column -->
              <ng-container matColumnDef="downloadUrl">
                <th mat-header-cell *matHeaderCellDef>Download</th>
                <td mat-cell *matCellDef="let request">
                  @if (request.downloadUrl) {
                    <span class="download-available">
                      <mat-icon>check_circle</mat-icon>
                      Available
                    </span>
                  } @else {
                    <span class="download-unavailable">
                      <mat-icon>hourglass_empty</mat-icon>
                      Not Ready
                    </span>
                  }
                </td>
              </ng-container>

              <!-- Expires At Column -->
              <ng-container matColumnDef="expiresAt">
                <th mat-header-cell *matHeaderCellDef>Expires</th>
                <td mat-cell *matCellDef="let request">
                  @if (request.expiresAt) {
                    <div [class.expiring-soon]="isExpiringSoon(request)">
                      @if (isExpiringSoon(request)) {
                        <mat-icon class="warning-icon">warning</mat-icon>
                      }
                      {{ formatDate(request.expiresAt) }}
                    </div>
                  } @else {
                    <span class="no-expiry">-</span>
                  }
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let request">
                  @if (request.status === DataExportStatus.COMPLETED && request.downloadUrl) {
                    <button
                      mat-icon-button
                      color="primary"
                      (click)="downloadExport(request)"
                      matTooltip="Download Export"
                    >
                      <mat-icon>download</mat-icon>
                    </button>
                  } @else if (request.status === DataExportStatus.FAILED) {
                    <button
                      mat-icon-button
                      color="warn"
                      matTooltip="Error: {{ request.errorMessage }}"
                    >
                      <mat-icon>error</mat-icon>
                    </button>
                  } @else if (request.status === DataExportStatus.PROCESSING) {
                    <mat-spinner diameter="24"></mat-spinner>
                  } @else {
                    <button mat-icon-button disabled>
                      <mat-icon>more_horiz</mat-icon>
                    </button>
                  }
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
          </div>
        }
      </mat-card-content>
    </mat-card>

    <!-- Information Card -->
    <mat-card class="info-card">
      <mat-card-content>
        <div class="info-content">
          <mat-icon class="info-icon">info</mat-icon>
          <div>
            <h3>About Data Export</h3>
            <p>
              You have the right to receive a copy of your personal data in a structured,
              commonly used, and machine-readable format.
            </p>
            <ul>
              <li><strong>Processing Time:</strong> Export requests are typically processed within 24-48 hours</li>
              <li><strong>Download Link:</strong> Download links are valid for 7 days after generation</li>
              <li><strong>Data Format:</strong> Choose between JSON (machine-readable) or CSV (spreadsheet) format</li>
              <li><strong>Data Included:</strong> Select specific categories or export all your data</li>
            </ul>
            <p class="note">
              For security reasons, you may be required to verify your identity before accessing the export.
            </p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
